<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Árvore da Vida – Interativa</title>
  <style>
    :root {
      /* Dark palette */
      --bg-dark: #0b0e12;
      --panel-dark: #11161e;
      --panel-2-dark: #0e131a;
      --text-dark: #e9eef5;
      --muted-dark: #9fb0c7;
      --accent-dark: #87b3ff;
      --link-dark: #a7c5ff;
      --edge-dark: #2e3f55;

      /* Light palette */
      --bg-light: #f7f9fc;
      --panel-light: #ffffff;
      --panel-2-light: #f3f6fb;
      --text-light: #0e1621;
      --muted-light: #4c5a6b;
      --accent-light: #2d5bff;
      --link-light: #204bcc;
      --edge-light: #5b6b80;

      --ring: 2px solid #2c3b50;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --panel: var(--panel-dark);
      --panel-2: var(--panel-2-dark);
      --text: var(--text-dark);
      --muted: var(--muted-dark);
      --accent: var(--accent-dark);
      --link: var(--link-dark);
      --edge: var(--edge-dark);
    }
    [data-theme="light"] {
      --bg: var(--bg-light);
      --panel: var(--panel-light);
      --panel-2: var(--panel-2-light);
      --text: var(--text-light);
      --muted: var(--muted-light);
      --accent: var(--accent-light);
      --link: var(--link-light);
      --edge: var(--edge-light);
      --shadow: 0 10px 30px rgba(0,0,0,.12);
    }

    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--text); background: var(--bg);
      display: grid; place-items: start center; padding: 24px;
    }

    .container { width: min(1100px, 96vw); }
    .card { background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid #212b39; border-radius: 18px; box-shadow: var(--shadow); overflow: hidden; }

    .header { display:flex; align-items:center; justify-content:space-between; gap:16px; padding:16px 18px; border-bottom: 1px solid #1f2835; }
    .header h1 { font-size: clamp(18px, 2.2vw, 24px); margin: 0; letter-spacing: .3px; }
    .sub { color: var(--muted); font-size: 13px; margin-top: 4px; }

    .controls { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }

    /* Toggle switch (para ambos) */
    .toggle { display:inline-flex; align-items:center; gap:10px; padding:6px 10px; background:var(--panel-2); border:1px solid #1f2835; border-radius:12px; }
    .switch { position:relative; display:inline-block; width:42px; height:24px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#7b8796; transition:.3s; border-radius:999px; }
    .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; top:3px; background:white; transition:.3s; border-radius:50%; box-shadow:0 1px 2px rgba(0,0,0,.4); }
    input:checked + .slider { background: var(--accent); }
    input:checked + .slider:before { transform: translateX(18px); }
    /* Ícones de sol/lua no trilho */
    .slider::after { content:'☾'; position:absolute; top:3px; right:6px; font-size:12px; color:#fff; opacity:.9; transition:.3s; }
    input:checked + .slider::after { content:'☀'; right:auto; left:6px; }
    .label { font-size:13px; color:var(--muted); }

    .stage { position: relative; }
    svg { width: 100%; height: auto; display:block; }
    .edge { stroke: var(--edge); stroke-width: 3.2; opacity: 0.95; }
    .edge:hover { stroke: #6aa7ff; opacity: 1; }

    .node { cursor: pointer; }
    .node circle { stroke: #bcd4ff; stroke-width: 1.4; }
    .node .label { font-size: 12px; fill: var(--text); text-anchor: middle; pointer-events: none; }
    .node .hebrew { font-size: 10.5px; fill:var(--muted); text-anchor: middle; pointer-events: none; }

    .tooltip { position: absolute; min-width: 260px; max-width: 320px; background: var(--panel-2); border: 1px solid #233045; border-radius: 14px; box-shadow: var(--shadow); padding: 12px; display: none; z-index: 30; color: var(--text); }
    .tt-head { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; }
    .tt-title { font-weight: 700; letter-spacing:.3px; }
    .tt-chip { font-size:11px; color:var(--muted); }
    .tt-color { width:18px; height:18px; border-radius:4px; border:1px solid rgba(255,255,255,.3); }
    .tt-right{display:flex;align-items:center;gap:8px}
    .tt-close { background:none; border:1px solid #233045; color: var(--text); cursor:pointer; font-size:12px; border-radius:8px; padding:4px 8px; }

    .tt-body { margin-top:8px; font-size: 13px; }
    .tt-body .row { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed #1f2a3b; }
    .row b { color:var(--accent); font-weight:600; }

    .tt-nav { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px; }
    .btn { background:var(--panel-2); border:1px solid #233045; color: var(--text); padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer; }
    .btn:hover { border-color:var(--accent); }
    .dots { display:flex; gap:6px; }
    .dot { width:6px; height:6px; border-radius:50%; background:#334154; }
    .dot.active { background:var(--accent); }

    .footer { padding: 12px 16px; border-top: 1px solid #1f2835; display:flex; align-items:center; justify-content:space-between; gap:12px; color:var(--muted); font-size: 12px; }
    .footer a { color: var(--link); text-decoration: none; }

    @media (max-width: 640px) {
      .tooltip { max-width: 92vw; }
      .legend { display:none; }
    }
  </style>
</head>
<body>
  <div class="container card">
    <div class="header">
      <div>
        <h1>Árvore da Vida – Interativa</h1>
        <div class="sub">Passe o mouse (ou toque) nos círculos para ver correspondências. Clique para fixar a janelinha; use ◀ ▶ para navegar.</div>
      </div>
      <div class="controls">
        <label class="toggle" title="Mostrar/ocultar Daath">
          <span class="label">Daath</span>
          <span class="switch"><input id="toggle-daath" type="checkbox" checked><span class="slider"></span></span>
        </label>
        <label class="toggle" title="Alternar modo claro/escuro">
          <span class="label" id="theme-label">Tema: escuro</span>
          <span class="switch"><input id="toggle-theme" type="checkbox"><span class="slider"></span></span>
        </label>
      </div>
    </div>

    <div class="stage">
      <svg id="tree" viewBox="0 0 800 980" role="img" aria-label="Diagrama interativo da Árvore da Vida"></svg>
      <div id="tooltip" class="tooltip" role="dialog" aria-live="polite"></div>
    </div>

    <div class="footer">
      <div>Baseado nas correspondências da Golden Dawn.</div>
    </div>
  </div>

<script>
(function(){
  const CONFIG = { nodeRadius: 20, nodeRadiusDaath: 16, fontHebrew: "'SBL Hebrew','Noto Sans Hebrew',serif" };
  const ARROW = '\u2194'; // "↔" como escape para evitar caracteres ilegais fora de strings
  const MDASH = '\u2014'; // "—"

  const POS = {
    1: {x:400, y: 80}, 2: {x:550, y:180}, 3: {x:250, y:180}, d: {x:400, y:220},
    4: {x:600, y:330}, 5: {x:200, y:330}, 6: {x:400, y:450}, 7: {x:600, y:600},
    8: {x:200, y:600}, 9: {x:400, y:750}, 10:{x:400, y:900}
  };

  const NODES = [
    { id:1, n:"1", name:"Kether", heb:"כתר", title:"Coroa", color:"#ffffff", astro:"Primum Mobile / Urano–Netuno", tarot:"—" },
    { id:2, n:"2", name:"Chokmah", heb:"חכמה", title:"Sabedoria", color:"#c0c4cb", astro:"Zodíaco / Urano", tarot:"—" },
    { id:3, n:"3", name:"Binah", heb:"בינה", title:"Compreensão", color:"#000000", astro:"Saturno", tarot:"—" },
    { id:"d", n:"—", name:"Daath", heb:"דעת", title:"Conhecimento", color:"#8e7fb3", astro:"Abismo / (atribuições não consensuais)", tarot:"—" },
    { id:4, n:"4", name:"Chesed", heb:"חסד", title:"Misericórdia", color:"#1d49a6", astro:"Júpiter", tarot:"—" },
    { id:5, n:"5", name:"Geburah", heb:"גבורה", title:"Rigor", color:"#c10f2b", astro:"Marte", tarot:"—" },
    { id:6, n:"6", name:"Tiferet", heb:"תפארת", title:"Beleza", color:"#ffd34d", astro:"Sol", tarot:"—" },
    { id:7, n:"7", name:"Netzach", heb:"נצח", title:"Vitória", color:"#10a36e", astro:"Vênus", tarot:"—" },
    { id:8, n:"8", name:"Hod", heb:"הוד", title:"Glória", color:"#ff8a00", astro:"Mercúrio", tarot:"—" },
    { id:9, n:"9", name:"Yesod", heb:"יסוד", title:"Fundamento", color:"#6a2c91", astro:"Lua", tarot:"—" },
    { id:10,n:"10", name:"Malkuth", heb:"מלכות", title:"Reino", color:"linear-gradient(90deg,#f0d54f 0%,#79824a 25%,#000000 50%,#4d2d1a 100%)", astro:"Terra / Elementos", tarot:"—" }
  ];

  const EDGES = [
    [1,2],[1,3],[1,6],[2,3],[2,4],[2,6],[3,5],[3,6],[4,5],[4,6],[4,7],[5,6],[5,8],[6,7],[6,8],[6,9],[7,8],[7,9],[7,10],[8,9],[8,10],[9,10]
  ];

  const PATH_META = [
    { num:11, pair:[1,2],  letter:"Aleph (א)",   attrib:"Ar",            tarot:"0 – O Louco",            color:"#f7f0a1" },
    { num:12, pair:[1,3],  letter:"Beth (ב)",    attrib:"Mercúrio",     tarot:"I – O Mago",            color:"#ffd84a" },
    { num:13, pair:[1,6],  letter:"Gimel (ג)",   attrib:"Lua",          tarot:"II – A Sacerdotisa",   color:"#dfe6ef" },
    { num:14, pair:[2,3],  letter:"Daleth (ד)",  attrib:"Vênus",        tarot:"III – A Imperatriz",   color:"#15a36e" },
    { num:15, pair:[2,6],  letter:"Heh (ה)",     attrib:"Áries",        tarot:"IV – O Imperador",     color:"#ff2b2b" },
    { num:16, pair:[2,4],  letter:"Vav (ו)",     attrib:"Touro",        tarot:"V – O Hierofante",     color:"#ff6a37" },
    { num:17, pair:[3,6],  letter:"Zain (ז)",    attrib:"Gêmeos",       tarot:"VI – Os Amantes",      color:"#ffa63b" },
    { num:18, pair:[3,5],  letter:"Cheth (ח)",   attrib:"Câncer",       tarot:"VII – O Carro",        color:"#ffbf4d" },
    { num:19, pair:[4,5],  letter:"Teth (ט)",    attrib:"Leão",         tarot:"VIII – A Força",       color:"#ffd64d" },
    { num:20, pair:[4,6],  letter:"Yod (י)",     attrib:"Virgem",       tarot:"IX – O Eremita",       color:"#c7dc5a" },
    { num:21, pair:[4,7],  letter:"Kaph (כ)",    attrib:"Júpiter",      tarot:"X – A Roda da Fortuna", color:"#6667ab" },
    { num:22, pair:[5,6],  letter:"Lamed (ל)",   attrib:"Libra",        tarot:"XI – A Justiça",       color:"#7bdba6" },
    { num:23, pair:[5,8],  letter:"Mem (מ)",     attrib:"Água",         tarot:"XII – O Enforcado",    color:"#164baf" },
    { num:24, pair:[6,7],  letter:"Nun (נ)",     attrib:"Escorpião",    tarot:"XIII – A Morte",       color:"#2aa387" },
    { num:25, pair:[6,9],  letter:"Samekh (ס)",  attrib:"Sagitário",    tarot:"XIV – A Temperança",   color:"#2672c2" },
    { num:26, pair:[6,8],  letter:"Ayin (ע)",    attrib:"Capricórnio",  tarot:"XV – O Diabo",         color:"#3d4c8c" },
    { num:27, pair:[7,8],  letter:"Peh (פ)",     attrib:"Marte",        tarot:"XVI – A Torre",         color:"#c1122a" },
    { num:28, pair:[7,9],  letter:"Tzaddi (צ)",  attrib:"Aquário",      tarot:"XVII – A Estrela",     color:"#a7c6ff" },
    { num:29, pair:[7,10], letter:"Qoph (ק)",    attrib:"Peixes",       tarot:"XVIII – A Lua",         color:"#3ea7a0" },
    { num:30, pair:[8,9],  letter:"Resh (ר)",    attrib:"Sol",          tarot:"XIX – O Sol",           color:"#ffb94a" },
    { num:31, pair:[8,10], letter:"Shin (ש)",    attrib:"Fogo",         tarot:"XX – O Julgamento",    color:"#ff3b3b" },
    { num:32, pair:[9,10], letter:"Tav (ת)",     attrib:"Saturno/Terra",tarot:"XXI – O Mundo",        color:"#20386a" }
  ];

  const svg = document.getElementById('tree');
  const tt  = document.getElementById('tooltip');
  const daathToggle = document.getElementById('toggle-daath');
  const themeToggle = document.getElementById('toggle-theme');
  const themeLabel  = document.getElementById('theme-label');

  // ===== Preferências (localStorage) =====
  const PREF_KEYS = { theme: 'treeTheme', daath: 'treeShowDaath' };
  function applyTheme(mode){
    document.documentElement.setAttribute('data-theme', mode);
    themeToggle.checked = (mode === 'light');
    if (themeLabel) themeLabel.textContent = `Tema: ${mode === 'light' ? 'claro' : 'escuro'}`;
  }
  function applyDaath(show){ daathToggle.checked = !!show; }
  (function initPreferences(){
    let storedTheme = localStorage.getItem(PREF_KEYS.theme);
    if(storedTheme !== 'light' && storedTheme !== 'dark'){
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      storedTheme = prefersLight ? 'light' : 'dark';
    }
    applyTheme(storedTheme);
    const storedDaath = localStorage.getItem(PREF_KEYS.daath);
    if(storedDaath !== null){ applyDaath(storedDaath === 'true'); }
  })();

  function clearSVG(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

  function draw(){
    clearSVG();
    // Edges
    EDGES.forEach(([a,b]) => {
      const p1 = POS[a]; const p2 = POS[b];
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', p1.x); line.setAttribute('y1', p1.y);
      line.setAttribute('x2', p2.x); line.setAttribute('y2', p2.y);
      line.setAttribute('class','edge');
      line.addEventListener('mouseenter', (e)=> showPathTooltip(e, a,b));
      line.addEventListener('mousemove', positionTooltip);
      line.addEventListener('mouseleave', hideTooltipIfNotPinned);
      line.addEventListener('click', (e)=> pinPathTooltip(e,a,b));
      svg.appendChild(line);
    });

    // Nodes
    const nodesToDraw = daathToggle.checked ? NODES : NODES.filter(n=>n.id!== 'd');
    nodesToDraw.forEach(n => {
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','node');
      const p = POS[n.id];
      const r = (n.id==='d') ? CONFIG.nodeRadiusDaath : CONFIG.nodeRadius;

      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx',p.x); circle.setAttribute('cy',p.y); circle.setAttribute('r', r);
      circle.setAttribute('fill', String(n.color).startsWith('linear-gradient') ? '#201a10' : n.color);
      circle.setAttribute('opacity', n.id==='d' ? 0.95 : 0.98);

      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x', p.x); text.setAttribute('y', p.y - r - 10); text.setAttribute('class','label'); text.textContent = `${n.n}. ${n.name}`;

      const heb = document.createElementNS('http://www.w3.org/2000/svg','text');
      heb.setAttribute('x', p.x); heb.setAttribute('y', p.y + r + 18); heb.setAttribute('class','hebrew'); heb.textContent = n.heb;

      g.appendChild(circle); g.appendChild(text); g.appendChild(heb);

      g.addEventListener('mouseenter', (e)=> showNodeTooltip(e, n));
      g.addEventListener('mousemove', positionTooltip);
      g.addEventListener('mouseleave', hideTooltipIfNotPinned);
      g.addEventListener('click', (e)=> pinNodeTooltip(e, n));

      svg.appendChild(g);

      if(n.id===10){
        const rim = document.createElementNS('http://www.w3.org/2000/svg','circle');
        rim.setAttribute('cx',p.x); rim.setAttribute('cy',p.y); rim.setAttribute('r', r+4);
        rim.setAttribute('fill','none'); rim.setAttribute('stroke','#7b6c2a'); rim.setAttribute('stroke-width','3'); rim.setAttribute('opacity','0.6');
        svg.appendChild(rim);
      }
    });
  }

  // ===== Tooltip (paginado) =====
  let pinned = false; let pageIndex = 0; let currentPayload = null;

  function tooltipPagesForNode(n){
    return [
      { key:"Básico", rows:[["Sephira", `${n.n}. ${n.name} (${n.heb})`],["Título", n.title],["Posição", positionName(n.id)]] },
      { key:"Astrologia/Tarot", rows:[["Atribuição", n.astro],["Arcano", n.tarot]] },
      { key:"Cor (Rei)", rows:[["Escala", colorLabel(n.color)],["Uso","Visualizações e consagração"]] }
    ];
  }
  function tooltipPagesForPath(a,b){
    const meta = PATH_META.find(p => samePair(p.pair,[a,b]));
    if(!meta) return [{ key:"Caminho", rows:[["Entre", `${a} ${ARROW} ${b}`],["Nota","Sem metadados"]]}];
    return [
      { key:"Caminho", rows:[["Entre", `${a} ${ARROW} ${b}`],["Letra", meta.letter]] },
      { key:"Atribuições", rows:[["Regência", meta.attrib],["Arcano", meta.tarot]] },
      { key:"Cor (Rei)", rows:[["Escala", colorLabel(meta.color)],["Uso","Meditação do caminho"]] }
    ];
  }
  function samePair(p,q){ return (p[0]===q[0] && p[1]===q[1]) || (p[0]===q[1] && p[1]===q[0]); }
  function getPathMeta(a,b){ return PATH_META.find(p => samePair(p.pair,[a,b])); }
  function positionName(id){
    const map = {1:"Topo (Kether)",2:"Pilar direito superior",3:"Pilar esquerdo superior",d:"Sobre o Abismo (Daath)",4:"Pilar direito médio",5:"Pilar esquerdo médio",6:"Centro (Tiferet)",7:"Pilar direito inferior",8:"Pilar esquerdo inferior",9:"Centro inferior (Yesod)",10:"Manifestação (Malkuth)"};
    return map[id] || "—";
  }
  function colorLabel(c){ return String(c).startsWith('linear-gradient') ? 'Quartetado (amarelo/oliva/preto/marrom)' : c; }

  function buildTooltipHTML(title, chip, color, pages){
    const dots = pages.map((_,i)=>`<span class="dot ${i===pageIndex?'active':''}"></span>`).join('');
    const rows = pages[pageIndex].rows.map(([k,v])=> `<div class="row"><b>${k}</b><span>${v}</span></div>`).join('');
    const colorBox = color ? `<div class="tt-color" style="background:${String(color).startsWith('linear-gradient')? 'transparent' : color}"></div>` : '';
    return `
      <div class="tt-head" data-drag="true">
        <div>
          <div class="tt-title">${title}</div>
          <div class="tt-chip">${chip}</div>
        </div>
        <div class="tt-right">${colorBox}<button class="tt-close" data-act="close" aria-label="Fechar tooltip">✕</button></div>
      </div>
      <div class="tt-body">${rows}</div>
      <div class="tt-nav">
        <button class="btn" data-act="prev">◀</button>
        <div class="dots">${dots}</div>
        <button class="btn" data-act="next">▶</button>
      </div>`;
  }

  function showNodeTooltip(evt, n){
    if(pinned) return; pageIndex=0; currentPayload={type:'node', data:n};
    const pages=tooltipPagesForNode(n);
    tt.innerHTML=buildTooltipHTML(`${n.n}. ${n.name}`, `${n.title} • Sephira`, n.color, pages);
    tt.dataset.pages=JSON.stringify(pages);
    tt.style.display='block'; positionTooltip(evt);
  }
  function pinNodeTooltip(evt,n){ pinned=true; showNodeTooltip(evt,n); }

  function showPathTooltip(evt,a,b){
    if(pinned) return; pageIndex = 0; currentPayload = {type:'path', data:{a,b}};
    const pages = tooltipPagesForPath(a,b);
    const meta = getPathMeta(a,b);
    const color = meta ? meta.color : '#2e3f55';
    const title = meta ? `Caminho ${meta.num} ${MDASH} ${meta.letter}` : `Caminho`;
    tt.innerHTML = buildTooltipHTML(title, `Letra/Signo/Tarot`, color, pages);
    tt.dataset.pages = JSON.stringify(pages);
    tt.style.display = 'block'; positionTooltip(evt);
  }
  function pinPathTooltip(evt,a,b){ pinned=true; showPathTooltip(evt,a,b); }

  function positionTooltip(evt){
    const pad=12; const rect=svg.getBoundingClientRect();
    let x=evt.clientX - rect.left + 14; let y=evt.clientY - rect.top + 14;
    const w=tt.offsetWidth||300; const h=tt.offsetHeight||180;
    const maxX=rect.width - w - pad; const maxY=rect.height - h - pad;
    tt.style.left=Math.max(pad, Math.min(x, maxX)) + 'px';
    tt.style.top=Math.max(pad, Math.min(y, maxY)) + 'px';
  }
  function hideTooltipIfNotPinned(){ if(!pinned){ tt.style.display='none'; } }

  tt.addEventListener('click', (e)=>{
    const act = e.target.getAttribute('data-act'); if(!act) return;
    if(act==='close'){ pinned=false; tt.style.display='none'; return; }
    const pages = JSON.parse(tt.dataset.pages || '[]');
    if(act==='prev') pageIndex = (pageIndex - 1 + pages.length) % pages.length;
    if(act==='next') pageIndex = (pageIndex + 1) % pages.length;
    const title = (currentPayload?.type==='node')
      ? `${currentPayload.data.n}. ${currentPayload.data.name}`
      : (()=>{ const m = getPathMeta(currentPayload.data.a,currentPayload.data.b); return m ? `Caminho ${m.num} ${MDASH} ${m.letter}` : `Caminho`; })();
    const chip  = (currentPayload?.type==='node')? `${currentPayload.data.title} • Sephira` : `Letra/Signo/Tarot`;
    const color = (currentPayload?.type==='node')? currentPayload.data.color : (PATH_META.find(p=>samePair(p.pair,[currentPayload.data.a,currentPayload.data.b]))?.color || '#2e3f55');
    tt.innerHTML = buildTooltipHTML(title, chip, color, pages);
    tt.dataset.pages = JSON.stringify(pages);
  });

  // Drag do tooltip (desktop)
  (function enableDrag(){
    let isDown=false; let sx=0, sy=0, ox=0, oy=0;
    tt.addEventListener('mousedown', (e)=>{ if(e.target.closest('[data-drag]')){ isDown=true; sx=e.clientX; sy=e.clientY; ox=parseInt(tt.style.left||'0'); oy=parseInt(tt.style.top||'0'); e.preventDefault(); }});
    window.addEventListener('mousemove', (e)=>{ if(!isDown) return; const dx=e.clientX-sx, dy=e.clientY-sy; tt.style.left=(ox+dx)+"px"; tt.style.top=(oy+dy)+"px"; });
    window.addEventListener('mouseup', ()=> isDown=false);
  })();

  // ESC fecha tooltip
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ pinned=false; tt.style.display='none'; }});

  // Toggles
  daathToggle.addEventListener('change', ()=>{
    localStorage.setItem(PREF_KEYS.daath, String(daathToggle.checked));
    pinned=false; tt.style.display='none'; draw();
  });
  themeToggle.addEventListener('change', ()=>{
    const mode = themeToggle.checked ? 'light' : 'dark';
    localStorage.setItem(PREF_KEYS.theme, mode);
    document.documentElement.setAttribute('data-theme', mode);
    if (themeLabel) themeLabel.textContent = `Tema: ${mode === 'light' ? 'claro' : 'escuro'}`;
  });

  // Inicializa
  draw();

  // ======================
  // "Testes" rápidos (console)
  // ======================
  (function runTests(){
    const results = [];
    function t(name, fn){
      try{ fn(); console.log('✅', name); results.push(['ok', name]); }
      catch(err){ console.error('❌', name, err); results.push(['fail', name, String(err)]); }
    }
    // 1) 22 caminhos
    t('PATH_META tem 22 itens', ()=> { if(PATH_META.length!==22) throw new Error('esperado 22, veio '+PATH_META.length); });
    // 2) Números 11..32 únicos
    t('Caminhos numerados 11..32 únicos', ()=>{
      const nums = PATH_META.map(p=>p.num).sort((a,b)=>a-b);
      const expect = Array.from({length:22}, (_,i)=>11+i);
      const equal = nums.every((n,i)=>n===expect[i]);
      if(!equal) throw new Error('nums='+JSON.stringify(nums));
    });
    // 3) EDGES contém todos os pares (ordem irrelevante)
    t('Cada PATH pair existe em EDGES', ()=>{
      const hasPair = (a,b)=> EDGES.some(([x,y])=> (x===a && y===b) || (x===b && y===a));
      const missing = PATH_META.filter(p=> !hasPair(p.pair[0], p.pair[1]));
      if(missing.length) throw new Error('faltando pares: '+JSON.stringify(missing.map(m=>m.pair)));
    });
    // 4) Tooltip de caminho inclui "Entre a ↔ b"
    t('tooltipPagesForPath inclui Entre a '+ARROW+' b', ()=>{
      const pages = tooltipPagesForPath(6,9);
      const entre = pages[0].rows[0][1];
      if(!String(entre).includes(ARROW)) throw new Error('seta não presente');
    });
    // 5) Toggle Daath altera contagem de nós (de 11 para 10)
    t('Toggle Daath altera número de nós no DOM', ()=>{
      const before = svg.querySelectorAll('g.node').length;
      daathToggle.checked = false; daathToggle.dispatchEvent(new Event('change'));
      const afterOff = svg.querySelectorAll('g.node').length;
      if(!(before===11 && afterOff===10)) throw new Error(`contagens inesperadas before=${before} afterOff=${afterOff}`);
      daathToggle.checked = true; daathToggle.dispatchEvent(new Event('change'));
    });

    // Relatório visual mínimo
    const badge = document.createElement('div');
    const ok = results.every(r=>r[0]==='ok');
    badge.textContent = ok ? 'Testes: OK' : 'Testes: ver console';
    badge.style.cssText = 'position:fixed;bottom:12px;right:12px;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;border-radius:8px;font:12px/1 ui-sans-serif;z-index:99;';
    document.body.appendChild(badge);
    setTimeout(()=> badge.remove(), 4000);
  })();
})();
</script>
</body>
</html>
